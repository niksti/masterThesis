\documentclass{cacthesis}

%Define your additional packages here
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{amsfonts} 
%\usepackage{macros}

\begin{document}

	\frontmatter
	
	%%%%%%%%%%%%%
	%% Title page
	%%%%%%%%%%%%%
	\title{Incoercible Sale}
	\subtitle{Longer subtitle (if required)}	%Delete subtitle if not required
	\author{Nikolaos Stivaktakis}
	\date{September 26, 2019}
	\subject{Master Thesis}
	
	\publishers{
		\small
		\begin{tabular}{r l}
			Supervisors:  & Prof. Sebastian Faust, Ph.D. \\
			& 2nd supervisor \\
		\end{tabular}
	}
	\maketitle
	
	\section*{Abstract}
	Write an abstract
	
	\newpage
	
	%TODO Delete this comment for the final submission:
	\textcolor{red}{\textbf{!!! Prüfen Sie, dass der folgende Text aktuell ist (entsprechend der formalen Regeln des Studienbüros) !!! \\
	!!! Check that this text is up to date (according to formal rules of the examination office) !!!}}
	
	\section*{Erklärung zur Abschlussarbeit gemäß § 22 Abs. 7 APB TU Darmstadt}
	
	Hiermit versichere ich, \textcolor{red}{\textbf{Nikolaos Stivaktakis}}, die vorliegende Master-Thesis / Bachelor-Thesis gemäß § 22 Abs. 7 APB der TU Darmstadt ohne Hilfe Dritter und nur mit den angegebenen Quellen und Hilfsmitteln angefertigt zu haben. Alle Stellen, die Quellen entnommen wurden, sind als solche kenntlich gemacht worden. Diese Arbeit hat in gleicher oder ähnlicher Form noch keiner Prüfungsbehörde vorgelegen. 
	
	Mir ist bekannt, dass im Falle eines Plagiats (§38 Abs.2 APB) ein Täuschungsversuch vorliegt, der dazu führt, dass die Arbeit mit 5,0 bewertet und damit ein Prüfungsversuch verbraucht wird. Abschlussarbeiten dürfen nur einmal wiederholt werden.
	
	Bei einer Thesis des Fachbereichs Architektur entspricht die eingereichte elektronische Fassung dem vorgestellten Modell und den vorgelegten Plänen.
	
	\vspace{10pt}
	\hrule
	
	\section*{English translation for information purposes only:\\Thesis Statement pursuant to § 22 paragraph 7 of APB TU Darmstadt}
	
	I herewith formally declare that I, \textcolor{red}{\textbf{Nikolaos Stivaktakis}}, have written the submitted thesis independently pursuant to § 22 paragraph 7 of APB TU Darmstadt. I did not use any outside support except for the quoted literature and other sources mentioned in the paper. I clearly marked and separately listed all of the literature and all of the other sources which I employed when producing this academic work, either literally or in content. This thesis has not been handed in or published before in the same or similar form.
	
	I am aware, that in case of an attempt at deception based on plagiarism (§38 Abs. 2 APB), the thesis would be graded with 5,0 and counted as one failed examination attempt. The thesis may only be repeated once.
	
	For a thesis of the Department of Architecture, the submitted electronic version corresponds to the presented model and the submitted architectural plans.
	
	\vspace{10pt}
	\hrule
	\vspace{70pt}
	
	\noindent\begin{tabular}{l@{\hskip 1in}l}
		\makebox[1.8in]{\hrulefill} & \makebox[3.5in]{\hrulefill}\\
		Datum / Date & Unterschrift / Signature
	\end{tabular}
	
	\tableofcontents
	
	\mainmatter
	
	\chapter{Introduction}

\chapter{Preliminaries}
\section{Cryptography}
\section{Game Theory}
\section{Blockchains}
\section{Smart Contracts}
\section{Escrows}

\chapter{Related work}
\section{first escrowless protocol}
Zimbeck mit Bithalo
auch die analyse erwähnen
\section{digital vs Physical}
Hier unbedingt Asganokar sein paper erwähnen (sale of digital goods)

\chapter{Formalization}
\section{Entities}

\minisec{Seller}An entity that owns a specific physical good $G$. The seller has bigger utility in owning $P$ amount of coins in contrast to owning $G$. He therefore desires to exchange $G$ against coins of amount $P$.

%Insert Utility function distribution
%u_s(p coins & good) > u_s(p coins) > u_s(good) > u_s(Nothing)

\minisec{Buyer}An entity that owns coins of at least amount of $P$. The Buyer has greater utility in owning $G$ in contrast to  owning $P$ amount of coins. He therefore desires to exchange coins of amount $P$ against $G$.

%Insert Utility function distribution
%u_b(p coins & good) > u_b(good) > u_b(p coins) > u_b(Nothing)

\minisec{Escrow/Smart Contract} An entity that should ensure that the trade is successful. It acts as a fully trusted oracle.

%TODO: Helper box protects the buyer from coercion by the seller
\minisec{Helper Box} Fully trusted by Buyer.  //need to expand on that

\section{The Game}

\minisec{Start Point}
A Seller and a buyer want to trade successfully: Both have funds in the given cryptocurrency. The seller is in possession of the physical good.

\minisec{End Point}
The buyer is in possession of the physical good and his funds have decreased by amount p. The funds of the seller have increased by p.

\minisec{Assumptions}
Both entities have access to the Escrow and know the addresses of each other. The seller also knows the physical address to which the buyer wants the good to be shipped. Other than this information they know nothing about each other.\newline Both parties can send funds in the given cryptocurrency to any address. The sender has the power to send/ship the physical good to any physical address he wants. The Escrow is a smart contract and both the seller and the buyer know the code of the Smart Contract.\newline
We assume both entities to behave rational, meaning that they both want to maximise their expected payout.\newline
Transaction Fees and Fees for the escrows are not analysed.



\minisec{Success of the trade}
The trade is considered successful if the situation transitions from the start point to the end point.

\minisec{Goal}
The goal is to design the Escrow in such a way, that it is the best strategy for both the buyer and the seller to perform a successful trade. That means that a successful trade should be the Nash Equilibrium.

%\subsection{Implementation}
%The underlying blockchain is immutable as long as there is an honest majority of %miners. We assume this honest majority.

\chapter{Proposed Possible Solutions}
To analyse turn based games we will use game trees. 
\minisec{Example Tree}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 3cm]{node[shape = rectangle]{$P_S | P_B$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$P_S | P_B$}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child{node[draw]{S}
            child[sibling distance = 3cm]{node[shape=rectangle]{$P_S | P_B$}edge from parent node [left] {$H_S$}}
            child[sibling distance = 3cm]{node[shape = rectangle]{$P_S | P_B$}edge from parent node [right] {$-H_S$}}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}
\minisec{Description}

To analyse simultaneous games we will use a table.
\minisec{Example table}
\begin{center}
\begin{tabular}{ c||c|c| }
& $H_B$ & $-H_B$  \\
\hline
\hline
$H_S$ & $P_S | P_B$ & $P_S | P_B$ \\
\hline
$-H_S$ & $P_S | P_B$ & $P_S | P_B$ \\ 
\hline
\end{tabular}
\end{center}

\minisec{Description} On the top are the possible strategies for the buyer: $H_B$ is the strategy where the buyer behaves honestly and $-H_B$ is the strategy where the Buyer behaves dishonestly.\newline
On the left side are the strategies for the seller. Similar to the buyer, $H_S$ denotes the strategy where the seller behaves honestly and $-H_S$ denotes the strategy where the seller behaves dishonestly.\newline

For each combination of strategies the two parties get a specific payout. $P_S$ denotes the payout of the seller and $P_B$ denotes the payout of the buyer.
\section{The naive approach}
To examine any possible solutions, we begin with the simplest possible protocol.\newline
The simplest protocol is without collateral and any third party. In this case there are 3 possibilities:
\begin{itemize}
	\item First the buyer sends coins of amount $P$ to the seller and then the seller ships the physical good $G$ to the provided address. 
	\item First the seller ships the physical good $G$ to the provided address and then the buyer sends coins of amount $P$ to the seller. 
	\item Both parties send the resources simultaneously
\end{itemize}
 the following: The buyer sends coins of amount $P$ to the seller and then the seller ships the physical good $G$ to the provided address. There is no third party involved. 
%Here maybe a visualization

\minisec{Payout: The Buyer sends first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 3cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$P|-P$}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child{node{0$|$0} edge from parent node [right] {$-H_B$}};
\end{tikzpicture}\newline
To analyze the payout, we start at the bottom at the seller's decision. As he would choose the option, which yields him the greatest payout, he chooses $-H_S$ ($P > P - U_S(G)$).\newline
Therefore the Buyers has to choose between a payout of 0 (by choosing $-H_B$) and $-P$ (by choosing $H_B$). Since $0 > -P$, he chooses $-H_B$.\newline
The Nash Equilibrium of this game is \{$-H_S$, $-H_B$\} and results in a payout of $0|0$. Both parties are not sending anything and the trade is unsuccessful.

\minisec{Payout: The Sender sends first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{S}
        child{node[draw]{B}
                child[sibling distance = 4cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                child[sibling distance = 4cm]{node[shape=rectangle]{$-U_S(G)|U_B(G)$}edge from parent node [right] {$-H_B$}} edge from parent node [left] {$H_S$}} 
        child{node{0$|$0} edge from parent node [right] {$-H_S$}};
\end{tikzpicture}\newline
The analysis is similar to the above case, but the roles are reversed. The Buyer would choose $-H_B$ as $U_B(G) > U_B(G)-P$.\newline
The seller would choose $-H_S$ as $0 > -U_S(G)$.\newline
The Nash Equilibrium of this game is \{$-H_S$, $-H_B$\} and results in a payout of $0|0$. Again, both parties are not sending anything and the trade is unsuccessful.

\minisec{Payout: Both parties send simultaneous}

\begin{center}
\begin{tabular}{ c||c|c| }
& $H_B$ & $-H_B$  \\
\hline
\hline
$H_S$ & $P - U_S(G)|U_B(G) - P$ & $-U_S(G) | U_B(G)$ \\
\hline
$-H_S$ & $P |-P$ & $0 | 0$ \\ 
\hline
\end{tabular}
\end{center}

If we look at the payout table we can see that $-H_B$ dominates $H_B$ and $-H_S$ dominates $H_S$. This means that the dishonest strategy provides a bigger payout regardless of the strategy of the other party. \newline
Since we assume the players to be rational, they would both chose the dishonest strategy. Both players choosing the dishonest strategy is the Nash Equilibrium of the game.\newline
It is interesting to note that this table resembles the famous prisoner's dilemma.
%TODO find literature to the prisoners dilemma
The Nash Equilibrium is on both parties not sending anything, still it would be better for both parties if they just traded honestly. 

\section{One Side collateral}
To incentivize an entity to behave honestly we introduce collateral. The collateral will be lost if the entity does not behave honestly. In this section we will look at protocols where only one entity deposits a collateral.

\subsection{Buyer Collateral}
Following protocol is proposed:
\begin{enumerate}
    \item Buyer deposits collateral $C > P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller 
    \item After receiving $G$, the Buyer sends funds of amount $P$ to the seller 
    \item The Smart Contract releases the collateral of the Buyer
\end{enumerate}

Because the Smart Contract has access to the blockchain, it can automatically release the collateral if the Buyer sends $P$  to the seller. The collateral should incentivize the Buyer to pay the seller after receiving the physical good $G$.

\minisec{Possible Strategies}
With this new protocol there are new possible strategies. Of course there is still the honest strategy($H_S$ and $H_B$) for both players, where they behave according to the protocol description. With this strategy the trade unravels successfully.\newline
But there exist other strategies: The dishonest strategy is again not sending the resources. This strategy is again denoted as $-H_B$ (when the buyer does not send the coins) and $-H_S$ (when the seller does not send the physical good.\newline
The Buyer can also refuse to pay the collateral to the Smart Contract. This behaviour is denoted as $-C_B$.\newline
When the Seller does not send the physical good in step 2 (plays strategy $-H_S$), the Buyer still has to decide if he wants to send $P$ to the seller in order to get back his collateral. Sending $P$ in this scenario is denoted as P$_B$ and not sending $P$ is denoted as $-P_B$.\newline

\minisec{Payout}

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 7cm]{node[draw]{B}
                		child[sibling distance = 4cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                		child[sibling distance = 4cm]{node[shape=rectangle]{-$U_S(G)|U_B(G)$-C}edge from parent node [right] {$-H_B$}} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 7cm]{node[draw]{B}
                child[sibling distance = 3cm]{node[shape = rectangle]{$P|-P$} edge from parent node [left] {$P_B$}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$0|-C$}edge from parent node [right] {$-P_B$}}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 10cm]{node[shape = rectangle]{$0|0$}edge from parent node [right] {$-C_B$}};
\end{tikzpicture}\newline
To analyze the Payout, we again start at the bottom at the Buyer's decision. On the left branch the Buyer would choose $H_B$, as $U_B(G) - P > U_B(G) - C$.\newline
On the right branch the Buyer would choose -P$_B$, as $-P > C$.\newline
Based on these decisions the Seller would choose $-H_S$, because $P > P - U_S(G)$.\newline
This means that it is better for the seller to behave maliciously and not send the physical good $G$. The Buyer would send $P$ to get back his collateral but receive nothing more, leaving him with a payout of $-P$. \newline
Since $-P < 0$, the Buyer would choose $-C_B$ and not even deposit the collateral.\newline
The Nash Equilibrium is at \{-H$_C$\} and the trade is unsuccessful.


\subsection{Seller Collateral}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C > P$ to the Smart Contract
    \item Buyer sends funds of amount $P$ to the seller 
    \item Seller sends the physical good to the Buyer
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller
\end{enumerate}
The collateral should incentivize the Seller to behave honestly and to ship the physical good to the buyer.
%Because of the collateral, behaving honestly should be the best strategy for the seller.
\minisec{Possible Strategies}
There is still the honest strategy ($H_S$, $H_B$) for both players, where they behave according to the protocol description. With this strategy, the trade still unravels successfully.\newline
The dishonest strategy is again not sending the resources. This strategy is still denoted as $-H_B$ (when the buyer does not send the coins) and $-H_S$ (when the seller does not send the physical good.\newline
The Buyer has also a unique opportunity: Since he decides what happens to the collateral, he can coerce the Seller into sending him extra resources. This strategy will be denoted $C_B$.  After receiving the physical good he can tell the Seller: "Either you send me back my payment $P$ or I will tell the Smart Contract that you did not send me the physical good." In this case the Seller has two possible answers: he can comply and send back $P$ ($C_S$) or not comply and ignore the message ($-C_S$).\newline

\minisec{Payout}

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 8cm]{node[draw]{B}
                		child[sibling distance = 4cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                		child[sibling distance = 4cm]{node[draw]{S}
                		    child[sibling distance = 4cm]{node[shape=rectangle]{$-U_S(G)|U_B(G)$} edge from parent node [left] {$C_S$}}
                		    child[sibling distance = 4cm]{node[shape=rectangle]{$P-C-U_S(G)|U_B(B)-P$} edge from parent node [right] {$-C_S$}}edge from parent node [right] {$C_B$}} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 8cm]{node[draw]{B}
                    child[sibling distance = 3cm]{node[shape = rectangle]{$P-C|-P$} edge from parent node [left] {$H_B$}} 
                    child[sibling distance = 3cm]{node[draw]{S}
                        child[sibling distance = 3cm]{node[shape=rectangle]{0$|$0} edge from parent node [left] {$C_S$}}
                        child[sibling distance = 3cm]{node[shape=rectangle]{$P-C|-P$} edge from parent node [right] {$-C_S$}}edge from parent node [right] {$C_B$}}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 10cm]{node[shape = rectangle]{$0|0$}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

Normally there is another layer under $C_B$: Does S comply and send P or not? As already discussed, it is always better for the seller to send back the payment $P$ and receive back his collateral $C$, because $C>P$. Should I put it in the tree? make it bigger and more difficult to read but completely correct.\newline

To analyze the payout, we again start at the bottom. Since $P>C$, the Seller would comply ($C_S$) on both instances.\newline
On both branches the Buyer chooses $C_B$: \[U_B(G)-P < U_B(G)\] \[-P < 0\]
Based on this information the Seller chooses $-H_S$: \[-U_S(G) < 0\]
The Nash Equilibrium is again at $0|0$ and the trade not successful.\newline
%If B sends the coins (does not choose strategy $-H_B$), S has to make the following decision: Does he send the good ($H_S$) or not ($-H_S$)? We have to take into account, that B decides what happens with the collateral. \newline
%If S does not behave honestly (does not send the good), B can punish S by reporting 0 to the Smart contract. This means, that the collateral would not be given back to S.
What was designed to be an incentive for S to behave honestly, ended up as leverage for B over S. B can report 0 (and burn the collateral) even if S behaves honestly. 
%Therefore B can use this leverage to coerce S into giving him extra resources: “Give me C/2 coins or I will report 0 to the Smart Contract and burn your collateral.“
%Since sending the good has no impact on the collateral (the rational buyer will always play strategy $C_B$ over $H_B$), it is best for S to not send the physical good ($-H_B$).
%Because not Sending ($-H_S$) is the best strategy for the seller, it is best for B to not even send P and therefore not engage in the trade at all ($-H_B$).\newline
%The Nash Equilibrium would be in nobody sending anything and the trade not happening.



\subsubsection{Both parties report}
One Side Collateral on the Seller's side does not work if only the Buyer reports to the Smart Contract (5.2.2). If only the Buyer reports, he has all the power and can report anything he wants to the Smart Contract.\newline
Another option would be that both players report to the Smart Contract if the physical good $G$ was sent and received.\newline 
If they report something different the Smart Contract slashes the collateral. If they both report 0 ($G$ was not sent), then the Smart Contract sends $P$ back to the Buyer. If they both report 1 ($G$ was sent), then the Smart Contract sends $P$ to the Seller.\newline
 
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C > P$ to the Smart Contract
    \item Buyer sends funds of amount $P$ to the Smart Contract 
    \item Seller sends the physical good to the Buyer and the Buyer receives it
    \item Buyer and Seller report the physical transaction to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller
\end{enumerate}
There are multiple ways to implement step 4. Either the two parties report one after another or they report simultaneously.

\subsubsection{Payout: The Buyer reports first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 9cm]{node[draw]{B}
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{1} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{2} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{3} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{4} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [left] {$H_S$}} 
                child[sibling distance = 9cm]{node[draw]{B}
                child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{5} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{6} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{7} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{8} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 10cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G)| U_B(G)$\\
\hline
2& $-C-U_S(G)| U_B(G)-P$\\
\hline
3&$-C-U_S(G)|U_B(G) -P$ \\
\hline
4& $P-U_S(G)| U_B(G) - P$\\
\hline
5& $0|0$\\
\hline 
6& $-C | -P$\\
\hline
7& $-C|-P$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}
Nash Equilibrium would be in case 5?\newline
seller would choose 1,4, 5, 8 (always what Buyer reports)\newline
Buyer would choose 1, 5 (always say he did not receive it)\newline
Seller would choose 5
\subsubsection{Payout: The Seller reports first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 9cm]{node[draw]{S}
                		child[sibling distance = 5cm]{node[draw]{B} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{1} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{2} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{B} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{3} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{4} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [left] {$H_S$}} 
                child[sibling distance = 9cm]{node[draw]{S}
                child[sibling distance = 5cm]{node[draw]{B} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{5} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{6} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{B} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{7} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{8} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 10cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G)| U_B(G)$\\
\hline
2& $-C-U_S(G)|U_B(G) -P$\\
\hline
3&$-C-U_S(G)|U_B(G)-P$ \\
\hline
4& $P-U_S(G)| U_B(G) - P$\\
\hline
5& $0|0$\\
\hline 
6& $-C | -P$\\
\hline
7& $-C|-P$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}

Buyer chooses 1,5, coerce: i report 1 but you send me P + C/2\newline
Can he only threaten it if his payout does not change? If it changes, is this threat not believable?\newline
Seller chooses 5?\newline
Nash Equilibrium again $0|0$ and trade unsuccessful. 

\minisec{Payout: Both parties reports simultaneously}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 7cm]{node[draw]{$T_1$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 7cm]{node[draw]{$T_2$} edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child[sibling distance = 10cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ c||c|c| }
$T_1$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $-U_S(G) | U_B(G)$ & $-U_S(G) - C | U_B(G) - P$ \\
\hline
1$_S$ & $-U_S(G) - C | U_B(G) - P$ & $P - U_S(G) | U_B(G) - P$\\ 
\hline
\end{tabular}
\end{center}

The Nash Equilibrium of $T_1$ is $\{0_B, 0_S\}$ and payout $-U_S(G) | U_B(G)$. What about $\{1_B, 1_S\}$ also Nash Equilibrium (No player can improve by changing the strategy)? 

\begin{center}
\begin{tabular}{ c||c|c| }
$T_2$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $0 | 0$ & $-C|-P$ \\
\hline
1$_S$ & $-C|-P$ & $P | -P$\\ 
\hline
\end{tabular}
\end{center}

The Nash Equilibrium of $T_2$ is $\{0_B, 0_S\}$ and payout $0 | 0$. What about $\{1_B, 1_S\}$ also Nash Equilibrium? What about strategy $C_B$ again?\newline

S would choose $-H_S$, because $0>-U_S(G)$.\newline
As both options lead to a payout of 0, B chooses an arbitrary option. The trade is unsuccessful again.


\section{Two Side Collateral}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Seller
    \item Seller sends physical good $G$ to the seller 
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller and the Buyer
\end{enumerate}

\minisec{Payout}

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 9cm]{node[draw]{B}
                		child[sibling distance = 5cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {1}} 
                		child[sibling distance = 5cm]{node[shape=rectangle]{$P-C_S - U_S(G)|U_B(G)-C_B - P$}edge from parent node [right] {0}} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 9cm]{node[draw]{B}
                child[sibling distance = 3cm]{node[shape = rectangle]{P$|$-P} edge from parent node [left] {1}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$P-C_S|-C_B-P$}edge from parent node [right] {0}}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 10cm]{node[shape = rectangle]{$0|-C$}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}


\section{SC 5/6 inputs What is a nice Headline for this section??}
\subsection{Ideal Functionality}
We can model the ideal functionality of our Smart Contract as a Function with 6 inputs and 2 outputs:

\minisec{Inputs}
\begin{itemize}
\item{Int: Buyer Collateral DO WE REALLY NEED THAT as input?}
\item{Int: Seller Collateral DO WE REALLY NEED THAT as input?}
\item{Int: the Price $P$}
\item{Bool: Sellers report}
\item{Bool: Buyers report}
\item{Bool: Was the physical good $G$ shipped by the seller?}
\end{itemize}

\minisec{Inputs MAYBE EASIER}
\begin{itemize}
\item{Int: agreed price $P$}
\item{Bool: Was the physical good $G$ shipped by the seller?}
\end{itemize}
Idea: the Smart Contract automatically collects  (instructs the entities to make a deposit) of the right amount. If the physical good was shipped, he transfers P to the Seller, else he gives back the initial deposit to both parties

\minisec{Outputs}
\begin{itemize}
\item{Int: Buyer Payout}
\item{Int: Seller Payout}
\end{itemize}

%\begin{equation}
%	SC_{ideal}:= ....	
%\end{equation}

\minisec{Functionality}
The function will always output the right amount to the two entities:
\begin{itemize}
    \item It slashes the collateral of all lying parties
    \item It will give the amount of $P$ to the seller if he actually ships the physical good $G$, otherwise give it back to the seller
\end{itemize}

\begin{verbatim}
function ideal_Functionality(int: buyerCollateral, int: sellerCollateral, int: price,
                        bool: sellerReport, bool: buyerReport, bool: shipped){
    if(sellerReports){
        if(buyerReports){
            if(shipped){
                return [price + sellerCollateral , buyerCollateral]
            }
            else{
                return [0, price]
            }
        }
        else{
            if(shipped){
                return [price + sellerCollateral, 0]
            }
            else{
                return [0, price + buyerCollateral]
            }
        }
    }else {
        if(buyerReports){
            if(shipped){
                return [price, buyerCollateral]
            }
            else{
                return [sellerCollateral, price]
            }
        }
        else{
            if(shipped){
                return [price, 0]
            }
            else{
                return [sellerCollateral, price + buyerCollateral]
            }
        }    
    }
}
\end{verbatim}

\subsubsection{Protocol}
Similar to section 5.3, following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller and reports it to the Smart Contract
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\subsubsection{Payout}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{S}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{S}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $P -U_S(G) - C_S| U_B(G)-P - C_B$\\
\hline
2& $P-U_S(G)- C_S| U_B(G)-P $\\
\hline
3&$P-U_S(G) | U_B(G)-P - C_B$ \\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $-0 |- C_B$\\
\hline
7& $- C_S|0$\\
\hline
8& $-C_S| -C_B$\\
\hline
\end{tabular}
\end{center}

Remark: If any party does not send the collateral, the Smart Contract will release the collateral of the the other party and it would result in a payout of $0,0$. This option is not analyzed in the Game tree but has to be considered as an option for each party.\newline

We again start at the bottom of the tree at the Buyer's decision. A rational Buyer would always behave honestly (choose 2,4,5,7), as the honest behaviour always yields the bigger payout. Out of these options the Seller would choose outcome 4 ($H_S,1$), as this is the best outcome for him.\newline
The Nash Equilibrium is at \{$H_S$, 1, 1\}.\newline

Such a smart contract solves the problem completely as the Nash Equilibrium is both parties behaving honestly.
%TODO It resembles the case of shipping a digital verifiable good. %quote the paper that solved this problem
\subsection{Real World Functionality}
In the real world, the smart contract does not have the last input (bool:shipped). Therefore the Smart Contract does not know if the physical good was actually shipped or not. \newline
This poses the following problem: The last input was needed in every critical path of the algorithm. Even if all the other inputs were the same, the output of the ideal functionality depended on the last input. Without this input, previously different scenarios become indistinguishable for the Smart Contract. Without the sixth input, it is impossible to design a Smart Contract that achieves the ideal functionality described in section 5.4.1.

%\begin{equation}
 %   U_s(P) > U_s(nothing) 
%\end{equation}
\section{Formal Proof}

\minisec{General payoff function}

We introduce a general payout functions $P_B$ and $P_S$, that take two strategies as input and output the overall payout that a player receives when playing this strategy.\newline
A strategy is a set of decisions that define the behaviour of a player. %TODO: MAYBE PRELIMINARIES? LOOK AT THAT AGAIN
%Questions: How to model strategy, since payout is also dependent on opponent, assume minmax?\newline


\[P_S : \{ \textit{set of Seller strategies}\} \times \{ \textit{set of Buyer strategies}\} \to \mathbb{R}\]
\[P_B : \{ \textit{set of Seller strategies}\} \times \{ \textit{set of Buyer strategies}\} \to \mathbb{R}\]
%\[P_S : \{ \textit{set of strategies}\} \to \mathbb{R} \]
The honest strategy for each player ($honest_S, honest_B$) is behaving according to the agreed protocol.
\minisec{Transactions}
DEFINE $T$ as the set of all possible Transaction SETS. TODO think about that again.\newline
When both parties behave honestly both parties post numerous transactions to the Smart Contract. We call the set of transactions that an honest Seller posts $Tx\_honest_S$ and the transaction from an honest Buyer $Tx\_honest_B$.

\minisec{Payoff from the SC}
We introduce functions $SC_B$ and $SC_S$ that take as input all transactions to the Smart Contract and output the corresponding Payout from the Smart Contract:

\[ SC_S : \{T\} \times \{T\} \to \mathbb{R} \]
\[ SC_B : \{ \textit{set of transactions}\} \times \{ \textit{set of transactions}\} \to \mathbb{R} \]

\minisec{Begin formal proof}
Let us assume there exists a successful Game $G$ (as defined in 4.2). That means
\begin{equation}
    \forall s \in \{\textit{set of Seller strategies}\}: P_S(s, honest_B) \leq P_S(honest_S,honest_B)
\end{equation}
and
\begin{equation}
    \forall s \in \{\textit{set of Buyer strategies}\}: P_B(honest_S, s) \leq P_B(honest_S,honest_B)
\end{equation}
It is the best strategy to behave honestly if the other party behaves honestly as well.\newline


%In addition the game should be incoercible, meaning that the other party has no dishonest strategy that decreases the payout from the first party:
%I think this is a inreasonable assumption. How to model incoercible?
%\begin{equation}
 %   \forall s \in \{\textit{set of Buyer strategies}\}: P_S(honest_S, s) \geq P_S(honest_S,honest_B)
%\end{equation}
%\begin{equation}
 %   \forall s \in \{\textit{set of Seller strategies}\}: P_B(s, honest_B) \geq P_B(honest_S,honest_B)
%\end{equation}
\minisec{Payout honest case}
I have to ASSUME: P (overall payout) is only influenced by SC (Smart Contract payout) and G (physical good). Meaning the two players only send their funds through the smart contract and do not send/receive funds from third parties.\newline
Reason: If there exists a successful protocol where one party pays the other directly, we can transform it into a protocol where all payments are routed through the Smart Contract. Therefore there has to exist a protocol successful protocol where no party pays the other party directly.
\begin{equation}
    P_B(honest_S,honest_B) = SC_B(Tx\_honest_S, Tx\_honest_B) + U_B(G))
\end{equation} 
\begin{equation}
    P_S(honest_S,honest_B) = SC_S(Tx\_honest_S, Tx\_honest_B) - U_S(G) 
\end{equation}

As $U_B(G)$ is a constant, from (5.10 and 5.11):
\begin{equation}
    \forall Tx_B \in \{T\}: SC_B(Tx\_honest_S, Tx_B) \leq SC_B(Tx\_honest_S, Tx\_honest_B)
\end{equation}
If the seller posts the transactions $Tx\_honest_S$, posting the transactions $Tx\_honest_B$ will give B the biggest payout from the Smart Contract.
\minisec{Payout dishonest seller}
Strategy $dishonestSeller$: In this strategy the seller behaves according to the agreed protocol (and posts the exact same transactions to the Smart Contract as if he was honest), but does not send the physical good $G$ to the Buyer.\newline
His payout is (dependent on the buyers strategy $S_B$ (and Transactions $Tx_B$)):
\begin{equation}
    P_S(dishonestSeller,S_B) = SC_S(Tx\_honest_S,Tx_B)
\end{equation}
As the dishonest seller does not send the item, his payout is exactly the amount of coins that he gets from the smart contract.\newline

\minisec{It is profitable for the seller to behave malicious}
We already showed, that if the seller posts the transactions $Tx\_honest_S$, posting $Tx\_honest_B$ yields the biggest payout for B (5.13).\newline
Therefore the rational B will always post $Tx\_honest_B$ if the Seller posts $Tx\_honest_A$, even if the protocol requires a different behaviour. We call this strategy (posting $Tx\_honest_B$) $Post\_Tx\_honest_B$.\newline
The general payoff of a Seller using strategy $dishonestSeller$ is:

\begin{equation}
    P_S(dishonestSeller,Post\_Tx\_honest_B) = SC_S(Tx\_honest_S,Tx\_honest_B)
\end{equation}

As we assume $U_S(G) > 0$, this strategy yields a bigger payoff than the honest strategy (5.4, 5.7):
\[P_S(dishonestSeller,Post\_Tx\_honest_B) = P_S(honest_S,honest_B) + U_S(G)\]

This contradicts our assumption that $G$ is a successful Game as defined in 4.2, as the honest strategy is no longer the best strategy for the Seller.

\chapter{Open Research/ Questions}

\chapter{Conclusion}
	
	
	%\bibliographystyle{}
	%\bibliography{}
	
	\appendix
\end{document}