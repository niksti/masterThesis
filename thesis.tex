\documentclass{cacthesis}

%Define your additional packages here
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{amsfonts} 
\usepackage{macros}
\usepackage{biblatex}
\addbibresource{references.bib}

\begin{document}

	\frontmatter
	
	%%%%%%%%%%%%%
	%% Title page
	%%%%%%%%%%%%%
	\title{Incoercible Sale}
	\subtitle{Longer subtitle (if required)}	%Delete subtitle if not required
	\author{Nikolaos Stivaktakis}
	\date{September 26, 2019}
	\subject{Master Thesis}
	
	\publishers{
		\small
		\begin{tabular}{r l}
			Supervisors:  & Prof. Sebastian Faust, Ph.D. \\
			& 2nd supervisor \\
		\end{tabular}
	}
	\maketitle
	
	\section*{Abstract}
	Write an abstract
	
	\newpage
	
	%TODO Delete this comment for the final submission:
	\textcolor{red}{\textbf{!!! Prüfen Sie, dass der folgende Text aktuell ist (entsprechend der formalen Regeln des Studienbüros) !!! \\
	!!! Check that this text is up to date (according to formal rules of the examination office) !!!}}
	
	\section*{Erklärung zur Abschlussarbeit gemäß § 22 Abs. 7 APB TU Darmstadt}
	
	Hiermit versichere ich, \textcolor{red}{\textbf{Nikolaos Stivaktakis}}, die vorliegende Master-Thesis / Bachelor-Thesis gemäß § 22 Abs. 7 APB der TU Darmstadt ohne Hilfe Dritter und nur mit den angegebenen Quellen und Hilfsmitteln angefertigt zu haben. Alle Stellen, die Quellen entnommen wurden, sind als solche kenntlich gemacht worden. Diese Arbeit hat in gleicher oder ähnlicher Form noch keiner Prüfungsbehörde vorgelegen. 
	
	Mir ist bekannt, dass im Falle eines Plagiats (§38 Abs.2 APB) ein Täuschungsversuch vorliegt, der dazu führt, dass die Arbeit mit 5,0 bewertet und damit ein Prüfungsversuch verbraucht wird. Abschlussarbeiten dürfen nur einmal wiederholt werden.
	
	Bei einer Thesis des Fachbereichs Architektur entspricht die eingereichte elektronische Fassung dem vorgestellten Modell und den vorgelegten Plänen.
	
	\vspace{10pt}
	\hrule
	
	\section*{English translation for information purposes only:\\Thesis Statement pursuant to § 22 paragraph 7 of APB TU Darmstadt}
	
	I herewith formally declare that I, \textcolor{red}{\textbf{Nikolaos Stivaktakis}}, have written the submitted thesis independently pursuant to § 22 paragraph 7 of APB TU Darmstadt. I did not use any outside support except for the quoted literature and other sources mentioned in the paper. I clearly marked and separately listed all of the literature and all of the other sources which I employed when producing this academic work, either literally or in content. This thesis has not been handed in or published before in the same or similar form.
	
	I am aware, that in case of an attempt at deception based on plagiarism (§38 Abs. 2 APB), the thesis would be graded with 5,0 and counted as one failed examination attempt. The thesis may only be repeated once.
	
	For a thesis of the Department of Architecture, the submitted electronic version corresponds to the presented model and the submitted architectural plans.
	
	\vspace{10pt}
	\hrule
	\vspace{70pt}
	
	\noindent\begin{tabular}{l@{\hskip 1in}l}
		\makebox[1.8in]{\hrulefill} & \makebox[3.5in]{\hrulefill}\\
		Datum / Date & Unterschrift / Signature
	\end{tabular}
	
	\tableofcontents
	
	\mainmatter
	
	\chapter{Introduction}

\chapter{Preliminaries}
\section{Cryptography}
\section{Game Theory}
\section{Blockchains}
\section{Smart Contracts}
\section{Escrows}

\chapter{Related work}
\section{first escrowless protocol}
Zimbeck mit Bithalo
auch die analyse erwähnen
\section{digital vs Physical}
Hier unbedingt Asganokar sein paper erwähnen (sale of digital goods)

\chapter{Formalization}
\minisec{Utility function}
The utility function $U_P(G)$ describes how much utility a physical good $G$ provides to a player $P$. The output of this function is a numerical value, which corresponds to the amount of coins that have the same value as $U_P(G)$.
\section{Entities}

\minisec{Seller}An entity S that owns a specific physical good $G$. The seller has bigger utility in owning $P$ amount of coins in contrast to owning $G$. He therefore desires to exchange $G$ against coins of amount $P$.

%Insert Utility function distribution
\begin{equation}
    U_S(G) + P > P > U_S(G) > 0
\end{equation}

\minisec{Buyer}An entity B that owns coins of at least amount of $P$. The Buyer has greater utility in owning $G$ in contrast to  owning $P$ amount of coins. He therefore desires to exchange coins of amount $P$ against $G$.

%Insert Utility function distribution
\begin{equation}
    U_B(G) + P > U_B(G) > P > 0
\end{equation}

\minisec{Escrow/Smart Contract} An entity that should ensure that the trade is successful. It acts as a fully trusted oracle.

\section{The Game}

\minisec{Start Point}
A Seller and a buyer want to trade successfully: Both have funds in the given cryptocurrency. The seller is in possession of the physical good.

\minisec{End Point}
The buyer is in possession of the physical good and his funds have decreased by amount $P$. The funds of the seller have increased by $P$.

\minisec{Assumptions}
Both entities have access to the Smart Contract and know the addresses of each other. The seller also knows the physical address to which the buyer wants the good to be shipped. Other than this information they know nothing about each other.\newline 
Both parties can send funds in the given cryptocurrency to any address. The sender has the power to send/ship the physical good to any physical address he wants. Both the seller and the buyer know the code of the Smart Contract.\newline
We assume both entities to behave rationally, meaning that they both want to maximise their expected payout.\newline
Both $U_S(G)$ and $U_B(G)$ are positive. \newline
Transaction Fees and Fees for the escrows are not analysed.



\minisec{Success of the trade}
The trade is considered successful if the situation transitions from the start point to the end point.

\minisec{Goal}
The goal is to design a protocol in which behavior that results in a successful trade is a Nash Equilibrium.\newline
No trust should be required. This will be achieved, if it is the rational behaviour for both players to perform the trade. A successful trade should be a Nash Equilibrium: If the other party behaves honestly, the best strategy will be to behave honestly as well.\newline
%If the other party behaves rational it should be best to behave honest.
Another goal is that the trade is incoercible against rational attacks. It should be unprofitable, but not necessarily impossible, to decrease the payout of the other party, if the other party is behaving honestly. 


%\subsection{Implementation}
%The underlying blockchain is immutable as long as there is an honest majority of %miners. We assume this honest majority.

\chapter{Proposed Possible Solutions}
To analyse turn based games we will use game trees. 
\minisec{Example Tree}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 3cm]{node[shape = rectangle]{$P_S | P_B$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$P_S | P_B$}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child{node[draw]{S}
            child[sibling distance = 3cm]{node[shape=rectangle]{$P_S | P_B$}edge from parent node [left] {$H_S$}}
            child[sibling distance = 3cm]{node[shape = rectangle]{$P_S | P_B$}edge from parent node [right] {$-H_S$}}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}
\minisec{Description}

To analyse simultaneous games we will use a table.
\minisec{Example table}
\begin{center}
\begin{tabular}{ c||c|c| }
& $H_B$ & $-H_B$  \\
\hline
\hline
$H_S$ & $P_S | P_B$ & $P_S | P_B$ \\
\hline
$-H_S$ & $P_S | P_B$ & $P_S | P_B$ \\ 
\hline
\end{tabular}
\end{center}

\minisec{Description} On the top are the possible strategies for the buyer: $H_B$ is the strategy where the buyer behaves honestly and $-H_B$ is the strategy where the Buyer behaves dishonestly.\newline
On the left side are the strategies for the seller. Similar to the buyer, $H_S$ denotes the strategy where the seller behaves honestly and $-H_S$ denotes the strategy where the seller behaves dishonestly.\newline

For each combination of strategies the two parties get a specific payout. $P_S$ denotes the payout of the seller and $P_B$ denotes the payout of the buyer.
\section{The naive approach}
To examine any possible solutions, we begin with the simplest possible protocol.\newline
The simplest protocol is without collateral and any third party. In this case there are 3 possibilities:
\begin{itemize}
	\item First the buyer sends coins of amount $P$ to the seller and then the seller ships the physical good $G$ to the provided address. 
	\item First the seller ships the physical good $G$ to the provided address and then the buyer sends coins of amount $P$ to the seller. 
	\item Both parties send the resources simultaneously
\end{itemize}

%Here maybe a visualization

\minisec{Possible strategies}
There are many possible strategies for the two players. We will only analyse the strategies where a player plays honestly and the strategies where a player intentionally behaves dishonest to gain an advantage.\newline
In the above described protocols we analyse two strategies for each player. The Buyer can choose between strategy $H_B$ where he behaves honestly and sends the money and strategy $-H_B$ where the Buyer behaves dishonestly and does not send the money. The Seller can choose as well between strategy $H_S$ where he behaves honestly and sends the good $G$ and strategy $-H_S$ where the Buyer behaves dishonestly and does not send the $G$.
\minisec{Payout: The Buyer sends first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 7cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 7cm]{node[shape=rectangle]{$P|-P$}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child{node{0$|$0} edge from parent node [right] {$-H_B$}};
\end{tikzpicture}\newline
To analyze the payout, we start at the bottom at the seller's decision. As he would choose the option, which yields him the greatest payout, he chooses $-H_S$ (Because $P > P - U_S(G)$).\newline
Therefore the Buyers has to choose between a payout of 0 (by choosing $-H_B$) and $-P$ (by choosing $H_B$). Since $0 > -P$, he chooses $-H_B$.\newline
The Nash Equilibrium of this game is \{$-H_S$, $-H_B$\} and results in a payout of $0|0$. Both parties are not sending anything and the trade is unsuccessful.

\minisec{Payout: The Sender sends first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{S}
        child{node[draw]{B}
                child[sibling distance = 7cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                child[sibling distance = 7cm]{node[shape=rectangle]{$-U_S(G)|U_B(G)$}edge from parent node [right] {$-H_B$}} edge from parent node [left] {$H_S$}} 
        child{node{0$|$0} edge from parent node [right] {$-H_S$}};
\end{tikzpicture}\newline
The analysis is similar to the above case, but the roles are reversed. The Buyer would choose $-H_B$ as $U_B(G) > U_B(G)-P$.\newline
The seller would choose $-H_S$ as $0 > -U_S(G)$.\newline
The Nash Equilibrium of this game is \{$-H_S$, $-H_B$\} and results in a payout of $0|0$. Again, both parties are not sending anything and the trade is unsuccessful.

\minisec{Payout: Both parties send simultaneous}

\begin{center}
\begin{tabular}{ c||c|c| }
& $H_B$ & $-H_B$  \\
\hline
\hline
$H_S$ & $P - U_S(G)|U_B(G) - P$ & $-U_S(G) | U_B(G)$ \\
\hline
$-H_S$ & $P |-P$ & $0 | 0$ \\ 
\hline
\end{tabular}
\end{center}

If we look at the payout table we can see that $-H_B$ dominates $H_B$ and $-H_S$ dominates $H_S$. This means that the dishonest strategy provides a bigger payout regardless of the strategy of the other party. \newline
Since we assume the players to be rational, they would both chose the dishonest strategy. Both players choosing the dishonest strategy is the Nash Equilibrium of the game.\newline
It is interesting to note that this table resembles the famous prisoner's dilemma.
%TODO find literature to the prisoners dilemma
The Nash Equilibrium is on both parties not sending anything, still it would be better for both parties if they just traded honestly. 

\section{One Side collateral}
To incentivize an entity to behave honestly we introduce collateral. The collateral will be lost if the entity does not behave honestly. In this section we will look at protocols where only one entity deposits a collateral.

\subsection{Buyer Collateral}
Following protocol is proposed:
\begin{enumerate}
    \item Buyer deposits collateral $C > P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller 
    \item After receiving $G$, the Buyer sends funds of amount $P$ to the seller 
    \item The Smart Contract releases the collateral of the Buyer
\end{enumerate}

Because the Smart Contract has access to the blockchain, it can automatically release the collateral if the Buyer sends $P$  to the seller. The collateral should incentivize the Buyer to pay the seller after receiving the physical good $G$.

\minisec{Possible Strategies}
With this new protocol there are new possible strategies. Of course there is still the honest strategy($H_S$ and $H_B$) for both players, where they behave according to the protocol description. With this strategy the trade unravels successfully.\newline
But there exist other strategies: The dishonest strategy is again not sending the resources. This strategy is again denoted as $-H_B$ (when the buyer does not send the coins) and $-H_S$ (when the seller does not send the physical good.\newline
The Buyer can also refuse to pay the collateral to the Smart Contract. This behaviour is denoted as $-C_B$.\newline
When the Seller does not send the physical good in step 2 (plays strategy $-H_S$), the Buyer still has to decide if he wants to send $P$ to the seller in order to get back his collateral. Sending $P$ in this scenario is denoted as $P_B$ and not sending $P$ is denoted as $-P_B$.\newline

\minisec{Payout}

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 7cm]{node[draw]{B}
                		child[sibling distance = 4cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                		child[sibling distance = 4cm]{node[shape=rectangle]{-$U_S(G)|U_B(G)$-C}edge from parent node [right] {$-H_B$}} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 7cm]{node[draw]{B}
                child[sibling distance = 3cm]{node[shape = rectangle]{$P|-P$} edge from parent node [left] {$P_B$}} 
                child[sibling distance = 3cm]{node[shape=rectangle]{$0|-C$}edge from parent node [right] {$-P_B$}}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 7cm]{node[shape = rectangle]{$0|0$}edge from parent node [right] {$-C_B$}};
\end{tikzpicture}\newline
To analyze the Payout, we again start at the bottom at the Buyer's decision. On the left branch the Buyer would choose $H_B$, as $U_B(G) - P > U_B(G) - C$.\newline
On the right branch the Buyer would choose P$_B$, as $-P > -C$.\newline
Based on these decisions the Seller would choose $-H_S$, because $P > P - U_S(G)$.\newline
This means that it is better for the seller to behave maliciously and not send the physical good $G$. The Buyer would send $P$ to get back his collateral but receive nothing more, leaving him with a payout of $-P$. \newline
Since $-P < 0$, the Buyer would choose $-C_B$ and not even deposit the collateral.\newline
The Nash Equilibrium is at \{-C$_B$\} and the trade is unsuccessful.


\subsection{Seller Collateral}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C > P$ to the Smart Contract
    \item Buyer sends funds of amount $P$ to the seller 
    \item Seller sends the physical good to the Buyer
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller
\end{enumerate}
The collateral should incentivize the Seller to behave honestly and to ship the physical good to the buyer. The Buyer can report with a simple boolean input: 
\begin{itemize}
    \item 0 denotes that $G$ was not received
    \item 1 denotes that $G$ was received
\end{itemize}
%Because of the collateral, behaving honestly should be the best strategy for the seller.
\minisec{Possible Strategies}
There is still the honest strategy ($H_S$, $H_B$) for both players, where they behave according to the protocol description. With this strategy, the trade still unravels successfully.\newline
The dishonest strategy is again not sending the resources. This strategy is still denoted as $-H_B$ (when the buyer does not send the coins) and $-H_S$ (when the seller does not send the physical good.\newline
The Buyer also has a unique opportunity: Since he decides what happens to the collateral, he can coerce the Seller into sending him extra resources. This strategy will be denoted $C_B$.  After receiving the physical good he can tell the Seller: "Either you send me back my payment $P$ or I will tell the Smart Contract that you did not send me the physical good." In this case the Seller has two possible answers: He can comply and send back $P$ ($C_S$) or not comply and ignore the message ($-C_S$).\newline

\minisec{Payout}

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child[sibling distance = 9cm]{node[draw]{S}
                child[sibling distance = 8cm]{node[draw]{B}
                		child[sibling distance = 4cm]{node[shape = rectangle]{$P-U_S(G)|U_B(G)-P$} edge from parent node [left] {$H_B$}} 
                		child[sibling distance = 4cm]{node[draw]{S}
                		    child[sibling distance = 4cm]{node[shape=rectangle]{$-U_S(G)|U_B(G)$} edge from parent node [left] {$C_S$}}
                		    child[sibling distance = 4cm]{node[shape=rectangle]{$P-C-U_S(G)|U_B(B)-P$} edge from parent node [right] {$-C_S$}}edge from parent node [right] {$C_B$}} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 8cm]{node[draw]{B}
                    child[sibling distance = 3cm]{node[shape = rectangle]{$P-C|-P$} edge from parent node [left] {$H_B$}} 
                    child[sibling distance = 3cm]{node[draw]{S}
                        child[sibling distance = 3cm]{node[shape=rectangle]{0$|$0} edge from parent node [left] {$C_S$}}
                        child[sibling distance = 3cm]{node[shape=rectangle]{$P-C|-P$} edge from parent node [right] {$-C_S$}}edge from parent node [right] {$C_B$}}edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 8cm]{node[shape = rectangle]{$0|0$}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}\newline

To analyze the payout, we again start at the bottom. Since $C>P$, the Seller would comply ($C_S$) on both instances.\newline
On both branches the Buyer chooses $C_B$: \[U_B(G)-P < U_B(G)\] \[-P < 0\]
Based on this information the Seller chooses $-H_S$: \[-U_S(G) < 0\]
The Nash Equilibrium is again at $0|0$ and the trade not successful.\newline
%If B sends the coins (does not choose strategy $-H_B$), S has to make the following decision: Does he send the good ($H_S$) or not ($-H_S$)? We have to take into account, that B decides what happens with the collateral. \newline
%If S does not behave honestly (does not send the good), B can punish S by reporting 0 to the Smart contract. This means, that the collateral would not be given back to S.
What was designed to be an incentive for S to behave honestly, ended up as leverage for B over S. B can report 0 (and burn the collateral) even if S behaves honestly. 
%Therefore B can use this leverage to coerce S into giving him extra resources: “Give me C/2 coins or I will report 0 to the Smart Contract and burn your collateral.“
%Since sending the good has no impact on the collateral (the rational buyer will always play strategy $C_B$ over $H_B$), it is best for S to not send the physical good ($-H_B$).
%Because not Sending ($-H_S$) is the best strategy for the seller, it is best for B to not even send P and therefore not engage in the trade at all ($-H_B$).\newline
%The Nash Equilibrium would be in nobody sending anything and the trade not happening.



\subsubsection{Both parties report}
One Side Collateral on the Seller's side does not work if only the Buyer reports to the Smart Contract (5.2.2). If only the Buyer reports, he has all the power and can report anything he wants to the Smart Contract.\newline
Another option would be that both players report to the Smart Contract if the physical good $G$ was sent and received.\newline
Also, instead of sending the Payment $P$ directly to the Seller, the Buyer will send the payment to the Smart Contract. The Smart Contract will then, if both parties behave honestly, forward the payment to the Seller. This hands more power to the Smart Contract. With control over the collateral and the payment it has more options to punish dishonest behaviour.\newline 
If the two players report a different value, then the Smart Contract will slash the collateral, as one party has to be lying. If they both report 0 ($G$ was not sent), then the Smart Contract will send $P$ back to the Buyer, because $G$ was not shipped. If they both report 1 ($G$ was sent), then the Smart Contract will send $P$ to the Seller and the trade was successful.\newline
 
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C > P$ to the Smart Contract
    \item Buyer sends funds of amount $P$ to the Smart Contract 
    \item Seller sends the physical good to the Buyer and the Buyer receives it
    \item Buyer and Seller report the physical transaction to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller
\end{enumerate}
There are multiple ways to implement step 4. Either the two parties report one after another or they report simultaneously.
\subsubsection{The Seller reports first}
As the Buyer reports last, this protocols still gives the Buyer the power of burning the collateral of the Seller by reporting exactly the opposite from the Sellers report.\newline
Therefore he can still coerce the Seller into sending him back his payment. This strategy will be denoted as $C_B$. As we already have shown above, a rational seller will comply and send back the payment $P$ (this last decision will be omitted from the tree for better readability).\newline

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child[sibling distance = 8cm]{node[draw]{S}
                child[sibling distance = 9cm]{node[draw]{S}
                		child[sibling distance = 4.5cm]{node[draw]{B} 
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{1} edge from parent node [left] {0}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{2} edge from parent node [right] {1}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{3} edge from parent node [right] {$C_B$}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 4.5cm]{node[draw]{B} 
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{4} edge from parent node [left] {0}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{5} edge from parent node [right] {1}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{6} edge from parent node [right] {$C_B$}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [left] {$H_S$}} 
                child[sibling distance = 9cm]{node[draw]{S}
                child[sibling distance = 4.5cm]{node[draw]{B} 
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{7} edge from parent node [left] {0}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{8} edge from parent node [right] {1}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{9} edge from parent node [right] {$C_B$}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 4.5cm]{node[draw]{B} 
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{10} edge from parent node [left] {0}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{11} edge from parent node [right] {1}}
                		    child[sibling distance = 1.5cm]{node[shape = rectangle]{12} edge from parent node [right] {$C_B$}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 8cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G)| U_B(G)$\\
\hline
2& $-C-U_S(G)|U_B(G) -P$\\
\hline
3&$-U_S(G)|U_B(G)$ \\
\hline
4& $-C-U_S(G)|U_B(G)-P$ \\
\hline
5& $P-U_S(G)| U_B(G) - P$\\
\hline 
6& $-U_S(G)|U_B(G)$\\
\hline
7& $0|0$\\
\hline
8& $-C | -P$\\
\hline
9& $0|0$\\
\hline
10& $-C|-P$\\
\hline
11& $P| -P$\\
\hline
12& $0| 0$\\
\hline
\end{tabular}
\end{center}
To analyze the payout, we again start at the bottom. The Buyer chooses:
\begin{itemize}
    \item 1 or 3 over 2 ($U_B(G) > U_B(G) - P$)
    \item 6 over 5 and 4  ($U_B(G) > U_B(G) - P$)
    \item 7 or 9 over 8 ($0 > -C$)
    \item 12 over 10 and 11 ($0 > -P$)
\end{itemize}
The Buyer chooses:
\begin{itemize}
    \item 7 or 12 over 1 and 6 ($0>-U_S(G)$)
\end{itemize}
No matter which decision the Buyer takes at the top of the tree, the payout will be $0|0$ and the trade unsuccessful.

\subsubsection{Payout: The Buyer reports first}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child[sibling distance = 9cm]{node[draw]{S}
                child[sibling distance = 9cm]{node[draw]{B}
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{1} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{2} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{3} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{4} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [left] {$H_S$}} 
                child[sibling distance = 9cm]{node[draw]{B}
                child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{5} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{6} edge from parent node [right] {1}}
                		     edge from parent node [left] {0}} 
                		child[sibling distance = 5cm]{node[draw]{S} 
                		    child[sibling distance = 2cm]{node[shape = rectangle]{7} edge from parent node [left] {0}}
                		    child[sibling distance = 2cm]{node[shape = rectangle]{8} edge from parent node [right] {1}}
                		     edge from parent node [right] {1}}
                		     edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
          child[sibling distance = 9cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G)| U_B(G)$\\
\hline
2& $-C-U_S(G)| U_B(G)-P$\\
\hline
3&$-C-U_S(G)|U_B(G) -P$ \\
\hline
4& $P-U_S(G)| U_B(G) - P$\\
\hline
5& $0|0$\\
\hline 
6& $-C | -P$\\
\hline
7& $-C|-P$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}
To analyze the payout, we again start at the bottom. The seller chooses:
\begin{itemize}
    \item 1 over 2 ($-U_S(G)>-C - U_S(G)$)
    \item 4 over 3 ($P-U_S(G)> -C-U_S(G)$)
    \item 5 over 6 ($0 > -C$)
    \item 8 over 7 ($P > -C$)
\end{itemize}
The Seller always reports the same as the Buyer, because he will lose his collateral if he reports anything different.\newline
The Buyer chooses:
\begin{itemize}
    \item 1 over 4 ($U_B(G)>U_B(G) - P$)
    \item 5 over 8 ($0>-P$)
\end{itemize}
The Buyer always reports that he did not receive the item.\newline
As \[0 > -U_S(G)\] the Seller chooses not to send the physical good ($-H_S$).\newline
No matter which decision the Buyer takes at the top of the tree, the payout will be $0|0$ and the trade unsuccessful.


\minisec{How to report simultaneously}
 Every transaction to the Smart Contract is public. As the players have to report to the Smart Contract by sending a public transaction, the other player also knows what the first player reported. By just demanding both to report at the same time, the player who reports second does always know what value the first player reported. Then the report is not really simultaneous.\newline
 
 
 We can fix this problem by using a (at least) computationally hiding and binding commitment scheme. Both players would commit to their decision and send the commitment to the SC. The second player sees the commitment of the first player. Because the commitment scheme is computationally hiding and we assume the players to be computationally bounded, the commitment does not reveal any information about the actual decision of the first player. \newline
 After both players sent the commitment to the SC, they both send the opening value for their commitment to the SC. As the commitment is computationally binding, the players can not change what they initially reported. When a player does not send an opening value after a predefined time, the SC can punish the player by slashing his collateral.
\subsubsection{Payout: Both parties reports simultaneously}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{B}
        child{node[draw]{S}
                child[sibling distance = 7cm]{node[draw]{$T_1$} edge from parent node [left] {$H_S$}} 
                child[sibling distance = 7cm]{node[draw]{$T_2$} edge from parent node [right] {$-H_S$}} edge from parent node [left] {$H_B$}} 
        child[sibling distance = 10cm]{node[shape = rectangle]{0$|$0}edge from parent node [right] {$-H_B$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ c||c|c| }
$T_1$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $-U_S(G) | U_B(G)$ & $-U_S(G) - C | U_B(G) - P$ \\
\hline
1$_S$ & $-U_S(G) - C | U_B(G) - P$ & $P - U_S(G) | U_B(G) - P$\\ 
\hline
\end{tabular}
\end{center}

The Nash Equilibrium of $T_1$ is $\{0_B, 0_S\}$ and payout $-U_S(G) | U_B(G)$.

\begin{center}
\begin{tabular}{ c||c|c| }
$T_2$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $0 | 0$ & $-C|-P$ \\
\hline
1$_S$ & $-C|-P$ & $P | -P$\\ 
\hline
\end{tabular}
\end{center}

The Nash Equilibrium of $T_2$ is $\{0_B, 0_S\}$ and payout $0 | 0$. \newline

S would choose $-H_S$, because $0>-U_S(G)$.\newline
As both options lead to a payout of 0, B chooses an arbitrary option. The trade is unsuccessful again.


\section{Two side collateral}
One side collateral does not work. The party that does not deposit collateral always has an unfair advantage over the other party. \newline
When only the Buyer deposits collateral, the Seller has no incentive to send $G$. \newline
When only the Seller deposits collateral, the Buyer can coerce the Seller into sending back his payment $P$, because the Buyer can burn the collateral by reporting 0.\newline 

We introduce another protocol that addresses this problems. In this protocol both parties deposit collateral. This should incentivize the parties to both behave honestly.\newline
If the two parties report something different, the Smart Contract will slash the collateral of both players, as it can not determine which party is lying. If both parties report 0, the Smart Contract will send the payment $P$ back to the Buyer. If both parties report 1, the Smart Contract will send the payment $P$ to the Seller.  \newline

Again, there are three possible ways of handling the reports:
\begin{itemize}
    \item The Seller reports first
    \item The Buyer reports first
    \item Both players report simultaneously
\end{itemize}

\subsection{The Seller reports first}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller and reports it to the Smart Contract
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\minisec{Possible strategies}
As always, $H_S$ denotes the honest strategy, where the Seller sends $G$ and $-H_S$ denotes the dishonest strategy where the Seller does not send the $G$.

\minisec{Payout}
To increase readability, we do not plot the decisions from point 1 to point 3. If someone does not deposit the collateral, the Smart Contract aborts the trade and the payout is $0|0$. If the Buyer refuses to pay $P$ (step 3), he loses his collateral. The payout is $0|-C_B$\newline

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{S}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{S}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G) | U_B(G)$\\
\hline
2& $-U_S(G) - C_S| U_B(G)- P - C_B $\\
\hline
3&$-U_S(G) - C_S | U_B(G) -P - C_B$ \\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $-C_S |-P - C_B$\\
\hline
7& $-C_S| -P-C_B$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}

To analyze the payout, we start at the bottom of the tree. The Buyer would choose:
\begin{itemize}
    \item 1 over 2 ($U_B(G) > U_B(G) -P -C_B$)
    \item 4 over 3 ($U_B(G) - P > U_B(G) -P -C_B$)
    \item 5 over 6 ($0 > -P -C_B$)
    \item 8 over 7 ($-P > -P -C_B)$)
\end{itemize}
The Seller would choose option 8, as 
\[P>P-U_S(G)>0>-U_S(G)\]
Because the payout of the Buyer is $-P<0$, he would not engage in this trade and therefore refuse to pay the collateral in step 1. The trade is still unsuccessful.

\subsection{The Buyer reports first}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item Seller reports to the Smart Contract that he did send $G$
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\minisec{Possible strategies}
As always, $H_S$ denotes the honest strategy, where the Seller sends $G$ and $-H_S$ denotes the dishonest strategy where the Seller does not send the $G$.

\minisec{Payout}
To increase readability, we do not plot the decisions from point 1 to point 3. If someone does not deposit the collateral, the Smart Contract aborts the trade and the payout is $0|0$. If the Buyer refuses to pay $P$ (step 3), he loses his collateral. The payout is $0|-C_B$\newline

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{B}
    		child[sibling distance = 5cm]{node[draw]{S}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{S}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{B}
            child[sibling distance = 5cm]{node[draw]{S}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{S}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G) | U_B(G)$\\
\hline
2&$-U_S(G) - C_S | U_B(G) -P - C_B$ \\
\hline
3& $-U_S(G) - C_S| U_B(G)- P - C_B $\\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $-C_S |-P - C_B$\\
\hline
7& $-C_S| -P-C_B$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}

To analyze the payout, we start at the bottom of the tree. The Seller would choose:
\begin{itemize}
    \item 1 over 2 ($-U_S(G) > -U_S(G) -C_S$)
    \item 4 over 3 ($P -U_S(G) > -U_S(G) -C_B$)
    \item 5 over 6 ($0 > -C_S$)
    \item 8 over 7 ($P >-C_S$)
\end{itemize}
The Buyer would choose:
\begin{itemize}
    \item 1 over 4 ($U_B(G) > U_B(G) - P$)
    \item 5 over 8 ($0 > -P$)
\end{itemize}
The Buyer would always report 0, no matter if the Seller was honest or not.\newline
The Seller chooses $-H_S$, as 
\[0>-U_S(G)\]
The Seller will never send $G$ in this game and the trade is unsuccessful.

\subsection{Simultaneous report}
Following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller
    \item Both players report whether $G$ was shipped
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\minisec{Possible strategies}
As always, $H_S$ denotes the honest strategy, where the Seller sends $G$ and $-H_S$ denotes the dishonest strategy where the Seller does not send the $G$.

\minisec{Payout}
To increase readability, we do not plot the decisions from point 1 to point 3. If someone does not deposit the collateral, the Smart Contract aborts the trade and the payout is $0|0$. If the Buyer refuses to pay $P$ (step 3), he loses his collateral. The payout is $0|-C_B$.\newline

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
      \node[draw]{S}
            child[sibling distance = 7cm]{node[draw]{$T_1$} edge from parent node [left] {$H_S$}} 
            child[sibling distance = 7cm]{node[draw]{$T_2$} edge from parent node [right] {$-H_S$}};
\end{tikzpicture}


\begin{center}
\begin{tabular}{ c||c|c| }
$T_1$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $-U_S(G) | U_B(G)$ & $-U_S(G) - C_S | U_B(G) -  P - C_B$ \\
\hline
1$_S$ & $-U_S(G) - C_S | U_B(G) - P - C_B$& $P - U_S(G) | U_B(G) - P$\\ 
\hline
\end{tabular}
\end{center}

The Nash Equilibrium of $T_1$ is $\{0_B, 0_S\}$ and payout $-U_S(G) | U_B(G)$.

\begin{center}
\begin{tabular}{ c||c|c| }
$T_2$& 0$_B$ & 1$_B$   \\
\hline
\hline
0$_S$ & $0 | 0$ & $-C_S|-P-C_B$ \\
\hline
1$_S$ & $-C_S|-P-C_B$ & $P | -P$\\ 
\hline
\end{tabular}
\end{center}
\section{An extra input is needed}
The Smart Contract plays an important role in the two side collateral protocol. We want to create a Smart Contract that rewards honest behaviour and punishes dishonest behaviour.\newline 
Problems arise, because the Smart Contract does not know if the physical good $G$ was actually sent to the Buyer. Because of this missing information, it is impossible for the Smart Contract to settle disputes.
\subsection{Ideal Functionality}
We can achieve the ideal functionality of our Smart Contract by giving it the information whether the good was actually shipped as an input. We model the ideal behaviour with a function taking 6 inputs and giving 2 outputs.

\minisec{Inputs}
\begin{itemize}
\item{Int: Buyer Collateral}
\item{Int: Seller Collateral}
\item{Int: the Price $P$}
\item{Bool: Sellers report}
\item{Bool: Buyers report}
\item{Bool: The actual information, if $G$ was shipped by the seller}
\end{itemize}

\minisec{Outputs}
\begin{itemize}
\item{Int: Buyer Payout}
\item{Int: Seller Payout}
\end{itemize}

%\begin{equation}
%	SC_{ideal}:= ....	
%\end{equation}

\minisec{Functionality}
\begin{lstlisting}[language=java]
function assign_coins(
  buyerCol: natural, sellerCol: natural, price: natural,
  sellerSent: bool /* self reported */, buyerRecv: bool /* self reported */, 
  shipped: bool /* ground truth */
) -> (int /* seller coins */, int /* buyer coins */) {
  if sellerSent == buyerRecv { /* honest case, multiple possible solutions  */ }
  if (not sellerSent) and buyerRecv { /* nonsensical case, multiple possible solutions */ }

  // both claim they went through and the other player failed
  if shipped {
    sellerCoins: int >= price + sellerCol // honest seller
    buyerCoins: int < price + buyerCol - U_B(G) //lying Buyer
  } else {
    sellerCoins: int < sellerCol // lying seller
    buyerCoins: int > price + buyerCol // honest buyer
  }
  return (sellerCoins, buyerCoins)
}
\end{lstlisting}
The honest and nonsensical case can be implemented without the last input. There are multiple possible solutions.\newline
The important case is when the seller reports that he shipped the good and the Buyer reports that he did not receive it. Because the Smart Contract has the input 'shipped', it can determine which party is lying and which party is telling the truth.\newline
The Smart Contract settles the disputes in such a way that the honest party has a payout greater than zero and the lying party has a payout smaller than zero. Therefore it is unfavorable for any party to report wrongfully.\newline
It is important to see that the outputs of the function have to be implemented like this, to achieve the ideal functionality.\newline

\minisec{Honest Seller}
The honest Seller (line 10) ships the good to the Buyer and deposits collateral $C_S$. To have a positive general payout, his lowest possible payout from the smart Contract is $P + C_S$. His general payout is at least
\[P + C_S - C_S - U_S(G) = P - U_S(G) > 0\]

\minisec{Lying Buyer}
The Lying Buyer (line 11) receives $G$ and deposits collateral $C_S$ and Price $P$ to the Smart Contract. To have a negative general payout, his payout from the smart Contract has to be less than $P + Col_B - U_B(G)$. His general payout is less than
\[P + C_B - U_B(G) + U_B(G) - C_B -P = 0\]

\minisec{Dishonest Seller}
The dishonest Seller deposits collateral $C_S$ but does not ship the good $G$. To have a negative general payout, payout from the smart Contract has to be less than $C_S$. His general payout is less than
\[C_S - C_S = 0\]

\minisec{Honest Buyer}
The honest Buyer deposits collateral $C_S$ and Price $P$. To have a positive general payout, his payout from the smart Contract has to be greater than $P + C_S$. His general payout is greater than
\[P + C_S - C_S - P = 0\]

\subsection{Example Protocol}
The easiest implementation of the honest case is to give back their collateral. If the good was actually shipped, the Seller will be awarded coins of amount $P$, otherwise those coins go back to the Buyer.\newline
In the nonsensical case the SC will not give any coins back.\newline
In the case of a dispute the SC rewards all the coins to the honest party.

\begin{lstlisting}[language=java]
function assign_coins(
  buyerCol: natural, sellerCol: natural, price: natural,
  sellerSent: bool, buyerRecv: bool, shipped: bool
) -> (int /* seller coins */, int /* buyer coins */) {
  if sellerSent == buyerRecv { 
    sellerCoins = sellerCol // give back the collateral
    buyerCoins = buyerCol //give back the collateral
    if shipped{sellerCoins += price} // G was shipped, Seller gets price
    else {buyerCoins += price}// G was not shipped, Buyer gets price
    }
  if (not sellerSent) and buyerRecv { 
    sellerCoins = 0 //nonsensical case, give both parties no coins
    buyerCoins = 0
  }

  // both claim they went through and the other player failed
  if shipped {
    sellerCoins = price + sellerCol + buyerCol // honest seller
    buyerCoins =  0 //lying Buyer
  } else {
    sellerCoins = 0 // lying seller
    buyerCoins = price + selleCol + buyerCol // honest buyer
  }
  return (sellerCoins, buyerCoins)
}
\end{lstlisting}

\subsubsection{Protocol}
Similar to section 5.3, following protocol is proposed:
\begin{enumerate}
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the seller and reports it to the Smart Contract
    \item Buyer receives the physical good and confirms it to the Smart Contract
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\subsubsection{Payout}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{S}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{S}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G) | U_B(G)$\\
\hline
2& $-U_S(G) - C_S| U_B(G)-P - C_B  $\\
\hline
3&$P-U_S(G) + C_B | U_B(G)-P - C_B$ \\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $P + C_B |-P - C_B$\\
\hline
7& $- C_S| C_S$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}

Remark: If any party does not send the collateral, the Smart Contract will release the collateral of the the other party and it would result in a payout of $0,0$. This option is not analyzed in the Game tree but has to be considered as an option for each party.\newline

We again start at the bottom of the tree at the Buyer's decision. A rational Buyer would choose 2,4,5,7. Out of these options the Seller would choose outcome 4 ($H_S,1$), as this is the best outcome for him.\newline
The Nash Equilibrium is at \{$H_S$, 1, 1\} and the trade would unravel successfully.\newline

Such a smart contract solves the problem completely as the Nash Equilibrium is both parties behaving honestly.
%TODO It resembles the case of shipping a digital verifiable good. %quote the paper that solved this problem
\subsection{Real World Functionality}
In the real world, the smart contract does not have the last input (bool:shipped). Therefore the Smart Contract does not know if the physical good was actually shipped or not. \newline
This poses the following problem: The last input is needed to settle disputes. Even if all the other inputs are the same, the output of the ideal functionality depends on the last input. Without this input, previously different scenarios become indistinguishable for the Smart Contract.\newline
For example, it is impossible to differentiate between a lying seller that did not send the good $G$ but says he did, and a lying Buyer that received the good but says he did not.\newline 
Without the sixth input, it is impossible to design a Smart Contract that achieves the ideal functionality described in section 5.4.1.

\chapter{A redesigned game}
As we have shown (8.1), it is not possible (under our Assumptions) to design a protocol that would create a successful game (as described in 4.2). The biggest problem is that we have no reliable way of telling the Smart Contract whether the physical good $G$ was actually shipped or not. If there is a dispute, the Smart Contract does not know which party is lying and has to be punished.\newline
We need to rework our Assumptions and requirements for the game we want to design. For that it is is interesting to see, that the two side collateral protocol (5.3) is very close to achieving our goals. As already discussed, the problem is that the Seller is not actually incentivized to send the physical good $G$, because the Buyer is not incentivized to report his dishonest behaviour. The Buyer gets a bigger Payout when he lies to the Smart Contract instead of reporting the dishonest behaviour. Therefore a rational Buyer would never punish a dishonest Seller in this scenario. If a Seller thinks that the Buyer would punish him (the Buyer is not acting rational in this scenario), then the Seller is incentivized to send the physical good $G$.\newline
\minisec{Two Side Collateral with punishing Buyer}
\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{S}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{B}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{S}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{B}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G) | U_B(G)$\\
\hline
2& $-U_S(G) - C_S| U_B(G)- P - C_B $\\
\hline
3&$P-U_S(G) - C_S | U_B(G) -P - C_B$ \\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $-C_S |-P - C_B$\\
\hline
7& $- C_S| -P-C_S$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}
Now a punishing Buyer stops acting rational and chooses option 7 over 8.\newline
The Buyer chooses:
\begin{itemize}
    \item 1 over 2 ($U_B(G) > U_B(G) -P -C_B$)
    \item 4 over 3 ($U_B(G) - P > U_B(G) -P -C_B$)
    \item 5 over 6 ($0 > -P -C_B$)
    \item 7 over 8 (irrational decision)
\end{itemize}
The Seller would choose option 4, as 
\[P-U_S(G)>0>-U_S(G)>-C_S\]
The Seller now sends the good, because he the Buyer will punish him if he does not send it.
The Nash Equilibrium would be the honest case and the trade would unravel successfully.\newline
At first glance this seems counterintuitive: If the act of reporting benefits the Buyer, why would the rational Buyer not report the misbehaviour of the Seller? As the definition of a rational behaviour is maximizing the own Utility, would it not be rational to report the Seller?\newline
The answer to this question is no. It is more profitable for the Buyer to not report the misbehaviour, as he at least receives back his collateral.\newline
It is not the act of reporting that is profitable for the Buyer, rather it is the threat of reporting. If the Seller thinks that maybe the Buyer will report him, he is discouraged of trying to cheat and not sending $G$.\newline
The problem lies in the way we laid the rules for the game: As we defined both players as always behaving rational, the Seller knows that the Buyer can not report him, because it is not the rational decision.\newline
If the Seller did not know that the Buyer is always acting rational, he would be taking a great risk by not sending the physical good: the risk of being exposed and losing his collateral and his money $P$.\newline
We want to create a situation where the Seller evaluates the situation as being too risky to try and cheat. In this situation the rational Seller will behave honestly and  send $G$.\newline
To conclude: It is sufficient to turn the non credible threat of the Buyer (reporting 0 if $G$ is not shipped) into a credible threat for the double collateral protocol to succeed.

\minisec{Redesigning the game}
We redesign the game by adding another Entity. The purpose of the newly added Entity is to assist the Buyer in convincing the Seller that he will be punished if he does not send $G$. We need this Entity to maintain the rationality of the Buyer, as a rational Buyer will not report any dishonest behaviour of the Seller.\newline
This new Entity is not modeled as a rational party. It rather wants to achieve its goal, which is to turn the non credible threat of the Buyer to a credible threat. If this is achieved, a Seller knows that it is unprofitable to behave dishonestly.\newline
The third Entity will be fully trusted by the Buyer. It has its own physical address and  the ability to receive the physical good $G$. It also has the ability to evaluate, whether the received item actually is the agreed upon item ($G$).\newline
The third Entity also has its own wallet on the blockchain and can communicate with the Smart Contract and the Buyer.

\section{Formal definition of the new Entity}
\subsubsection{Adding an Entity}
We introduce another entity, which we call Mediator M and always has the same behaviour:
\begin{enumerate}
    \item publish his public key and physical address
    \item receive SC address and specifications that the describe $G$
    \item receive the physical good
    \item check, if the the physical good match the descriptions for $G$
    \begin{itemize}
        \item YES: report 1 to the SC and send the good to the Buyer
        \item NO: destroy the good and report 0 to the SC
    \end{itemize}
\end{enumerate}

\subsubsection{Assumptions for the new entity}
The new Entity always behaves in the described way. It has the power to receive physical items. Given the right specifications of $G$, the Mediator can distinguish $G$ from every other  physical item. The Mediator also has the power to communicate with the Smart Contract. 
//TODO Maybe expand on that: What about trust
\section{New proposed protocol}
We propose the following protocol:
\begin{enumerate}
    \item Buyer gives SC address and specifications for $G$ to the Mediator
    \item Seller deposits collateral $C_S > P$ to the Smart Contract
    \item Buyer deposits collateral $C_B > P$ to the Smart Contract
    \item Buyer sends Funds of amount $P$ to the Smart Contract
    \item Seller sends physical good $G$ to the Mediator and reports it to the Smart Contract
    \item Mediator receives the physical good, confirms it to the Smart Contract and sends $G$ to the Buyer
    \item The Smart Contract releases the collateral of the Seller and the Buyer and sends $P$ to the seller
\end{enumerate}
\subsubsection{Honest behaviour}
This new protocol does change the honest behaviour of the Buyer. His honest behaviour is now:
\begin{enumerate}
    \item Tell the right SC address and the right specifications for $G$ to the Mediator
    \item Deposit $C_B>P$ to the Smart Contract
    \item Send funds of amount $P$ to the Smart Contract
    \item Wait and receive $G$ from the Mediator
\end{enumerate}
It is important that the Buyer no longer reports to the Smart Contract, as this responsibility is handed over to the Mediator.\newline
The honest behaviour of the Seller remains unchanged by the new protocol. It still is:
\begin{enumerate}
    \item Deposit $C_S>P$ to the Smart Contract
    \item Send $G$ to the provided address (which is now the Mediator)
    \item Report to the Smart Contract  that $G$ was sent
\end{enumerate}



\section{Approaches}
\subsection{Friend of Buyer reports}
One possible approach is letting a loyal friend of the Buyer be the reporting Entity. It is important that he is loyal to the Buyer, meaning that he will not betray the Buyer and keep the physical good $G$ to himself. The Buyer fully trusts his loyal friend. 
\minisec{Modeling the Friend}
The friend will not act rational, as he does not want to maximize his own Utility. He rather wants to maximize the Buyer's utility. Therefore he will always choose the option that maximizes the payout of the Buyer.\newline
The Friend(F) will receive the physical good $G$ and check if it the agreed good. After that, he reports 0 (received the good successfully) or 1 (did not receive the good successfully) to the Smart Contract. After that he will send the $G$ to the Buyer.
\minisec{Protocol}
\begin{enumerate}
    \item Seller and Buyer deposit Collateral to the SC
    \item Buyer sends $P$ to the SC
    \item Seller ships $G$ to the Friend of the Buyer and reports 1/0 to the SC
    \item Friend of the Seller reports 1/0 to the SC
    \item Friend sends $G$ to the Buyer
\end{enumerate}

\minisec{Payout}
To increase readability, we do not plot the decisions from point 1 to point 3. If someone does not deposit the collateral, the Smart Contract aborts the trade and the payout is $0|0$. If the Buyer refuses to pay $P$ (step 3), he loses his collateral. The payout is $0|-C_B$\newline

\begin{tikzpicture}[sibling distance=7cm,level distance=6em,every node/.style={shape=circle,align=center}]
    \node[draw]{S}
        child[sibling distance = 9cm]{node[draw]{S}
    		child[sibling distance = 5cm]{node[draw]{F}
    		    child[sibling distance = 3cm]{node{1} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{2} edge from parent node [right] {1}}edge from parent node [left] {0}}
    		child[sibling distance = 5cm]{node[draw]{F}
    		    child[sibling distance = 3cm]{node{3} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{4} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [left] {$H_S$}} 
        child[sibling distance = 9cm]{node[draw]{S}
            child[sibling distance = 5cm]{node[draw]{F}
                child[sibling distance = 3cm]{node{5} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{6} edge from parent node [right] {1}}edge from parent node [left] {0}}
            child[sibling distance = 5cm]{node[draw]{F}
                child[sibling distance = 3cm]{node{7} edge from parent node [left] {0}}
    		    child[sibling distance = 3cm]{node{8} edge from parent node [right] {1}}edge from parent node [right] {1}}edge from parent node [right] {$-H_S$}};
\end{tikzpicture}

\begin{center}
\begin{tabular}{ |c|c| }
\hline
& Payout  \\
\hline
\hline
1& $-U_S(G) | U_B(G)$\\
\hline
2& $-U_S(G) - C_S| U_B(G)- P - C_B $\\
\hline
3&$P-U_S(G) - C_S | U_B(G) -P - C_B$ \\
\hline
4& $P-U_S(G)| U_B(G)-P$\\
\hline
5& $0|0$\\
\hline 
6& $-C_S |-P - C_B$\\
\hline
7& $- C_S| -P-C_S$\\
\hline
8& $P| -P$\\
\hline
\end{tabular}
\end{center}
We again start at the bottom of the tree to analyze the payout. As F wants to maximize the payout of the Buyer, he will choose:
\begin{itemize}
    \item 1 over 2 ($U_B(G) > U_B(G) -P -C_B$)
    \item 4 over 3 ($U_B(G) - P > U_B(G) -P -C_B$)
    \item 5 over 6 ($0 > -P -C_B$)
    \item 8 over 7 ($-P > -P -C_B)$)
\end{itemize}
The Seller would choose option 8, as 
\[P>P-U_S(G)>0>-U_S(G)\]
Because the payout of the Buyer is $-P<0$, he would not engage in this trade and therefore refuse to pay the collateral in step 1. The trade is still unsuccessful. \newline
Introducing a friend as the reporting Entity does not solve the problem. The tree and the payout are exactly the same as in the two side collateral protocol. As the Seller knows that F will act in the best interest of the Buyer, he can still misbehave without being punished.\newline
To solve the problem we need to come up with an reporting Entity that is fully trusted by the Buyer, but is not acting in his best interest. Every entity that is acting in the best interest for the Buyer will not be a credible threat to the Seller.
\subsection{AI Box reports}
TODO: SHOW THAT THIS APPROACH (HOPEFULLY) DOES WORK
\section{Difference from trusted third party/ Escrow}
How is the reporting entity different than an escrow?
-only buyer has to trust?
-Maybe even model rational: misbehaving is doing more damage to the company/manufacturer than behaving exactly as described -> then no trust is necessary -> but then we can us it as a clean middleman that reports to the SC
\chapter{Open Research/ Questions}

\chapter{Conclusion}

\chapter{Appendix}

\section{Formal proof}
In this section we provide a proof showing that (under our Assumptions) there can not exist  a successful game G as it is defined in 4.2.

\minisec{Assumptions}
\begin{enumerate}
    \item if the other party behaves honestly or rationally, it will be the best strategy to behave honestly
    \item $U_S(G)$ and $U_B(G)$ are constants $> 0$
    \item All Payments go through the smart Contract
    \item The players only interact with each other and the Smart Contract. There are no other entities involved.
    \item The entities interact with the SC with transactions. The payoff from the SC does only depend on these transactions.
    \item The Smart Contract handles the payoff after receiving all the transactions.
    \item The seller can post $Tx\_honest_S$, even if he does not send $G$. There is no mechanism for the Buyer to prevent the seller from posting $Tx_honest_S$.

\end{enumerate}

\minisec{General payout function}

We introduce a general payout functions $P_B$ and $P_S$, that take two strategies as input and output the overall payout that a player receives when playing this strategy.\newline
A strategy is a set of decisions that define the behaviour of a player. %TODO: MAYBE PRELIMINARIES? LOOK AT THAT AGAIN
%Questions: How to model strategy, since payout is also dependent on opponent, assume minmax?\newline


\[P_S : \{ \textit{set of Seller strategies}\} \times \{ \textit{set of Buyer strategies}\} \to \mathbb{R}\]
\[P_B : \{ \textit{set of Seller strategies}\} \times \{ \textit{set of Buyer strategies}\} \to \mathbb{R}\]
%\[P_S : \{ \textit{set of strategies}\} \to \mathbb{R} \]
The honest strategy for each player ($honest_S, honest_B$) is behaving according to the agreed protocol.
\minisec{Transactions}
DEFINE $T$ as the set of all possible Transaction SETS. TODO think about that again.\newline
When both parties behave honestly both parties post numerous transactions to the Smart Contract. We call the set of transactions that an honest Seller posts $Tx\_honest_S$ and the transaction from an honest Buyer $Tx\_honest_B$.

\minisec{payout from the SC}
We introduce functions $SC_B$ and $SC_S$ that take as input all transactions to the Smart Contract and output the corresponding Payout from the Smart Contract:

\[ SC_S : \{T\} \times \{T\} \to \mathbb{R} \]
\[ SC_B : \{T\} \times \{T\} \to \mathbb{R} \]

\minisec{Begin formal proof}
Let us assume there exists a successful Game $G$ (as defined in 4.2). That means
\begin{equation}
    \forall s \in \{\textit{set of Seller strategies}\}: P_S(s, honest_B) \leq P_S(honest_S,honest_B)
\end{equation}
and
\begin{equation}
    \forall s \in \{\textit{set of Buyer strategies}\}: P_B(honest_S, s) \leq P_B(honest_S,honest_B)
\end{equation}
It is the best strategy to behave honestly if the other party behaves honestly as well.\newline


%In addition the game should be incoercible, meaning that the other party has no dishonest strategy that decreases the payout from the first party:
%I think this is a inreasonable assumption. How to model incoercible?
%\begin{equation}
 %   \forall s \in \{\textit{set of Buyer strategies}\}: P_S(honest_S, s) \geq P_S(honest_S,honest_B)
%\end{equation}
%\begin{equation}
 %   \forall s \in \{\textit{set of Seller strategies}\}: P_B(s, honest_B) \geq P_B(honest_S,honest_B)
%\end{equation}
\minisec{Payout honest case}
\begin{equation}
    P_B(honest_S,honest_B) = SC_B(Tx\_honest_S, Tx\_honest_B) + U_B(G))
\end{equation} 
\begin{equation}
    P_S(honest_S,honest_B) = SC_S(Tx\_honest_S, Tx\_honest_B) - U_S(G) 
\end{equation}

As $U_B(G)$ is a constant, from (8.2 and 8.3):
\begin{equation}
    \forall Tx_B \in \{T\}: SC_B(Tx\_honest_S, Tx_B) \leq SC_B(Tx\_honest_S, Tx\_honest_B)
\end{equation}
If the seller posts the transactions $Tx\_honest_S$, posting the transactions $Tx\_honest_B$ will give B the biggest payout from the Smart Contract.
\minisec{Payout dishonest seller}
Strategy $dishonestSeller$: In this strategy the seller behaves according to the agreed protocol (and posts the exact same transactions to the Smart Contract as if he was honest), but does not send the physical good $G$ to the Buyer.\newline
His payout is (dependent on the buyers strategy $S_B$ (and Transactions $Tx_B$)):
\begin{equation}
    P_S(dishonestSeller,S_B) = SC_S(Tx\_honest_S,Tx_B)
\end{equation}
As the dishonest seller does not send the item, his payout is exactly the amount of coins that he gets from the smart contract.\newline

\minisec{It is profitable for the seller to behave malicious}
We already showed, that if the seller posts the transactions $Tx\_honest_S$, posting $Tx\_honest_B$ yields the biggest payout for B (8.5).\newline
Therefore the rational B will always post $Tx\_honest_B$ if the Seller posts $Tx\_honest_A$, even if the protocol requires a different behaviour. We call this strategy (posting $Tx\_honest_B$) $Post\_Tx\_honest_B$.\newline
The general payout of a Seller using strategy $dishonestSeller$ is:

\begin{equation}
    P_S(dishonestSeller,Post\_Tx\_honest_B) = SC_S(Tx\_honest_S,Tx\_honest_B)
\end{equation}

As we assume $U_S(G) > 0$, this strategy yields a bigger payout than the honest strategy (8.4, 8.7):
\[P_S(dishonestSeller,Post\_Tx\_honest_B) = P_S(honest_S,honest_B) + U_S(G)\]

This contradicts our assumption that $G$ is a successful Game as defined in 4.2, as the honest strategy is no longer the best strategy for the Seller when the buyer is acting rational.
 %\begin{figure}[!htbp]
    %\begin{systembox}{A}
%	ss
    %\end{systembox}
 %\end{figure}
	
	%\bibliographystyle{}
	
	%\bibliography{references.bib}
	\printbibliography
	
	\appendix
\end{document}